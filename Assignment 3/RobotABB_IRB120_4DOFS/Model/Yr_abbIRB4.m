function Yr_out = Yr_abbIRB4(u)
%YR_ABBIRB4 Computes the Robot regressor

% Joint Position
q1=u(1);
q2=u(2);
q3=u(3);
q4=u(4);


% Joint Velocity
qp1=u(5);
qp2=u(6);
qp3=u(7);
qp4=u(8);


% Joint Velocity reference
qp1r=u(9);
qp2r=u(10);
qp3r=u(11);
qp4r=u(12);


% Joint Acceleration reference
qpp1r=u(13);
qpp2r=u(14);
qpp3r=u(15);
qpp4r=u(16);

%Gravity
gz=u(17);

% Kinematic Parameters
L=abbIRB4_params;

% Angle offset
al=L(5);

% TODO: Define the robot regressor Yr(q,qp,qpr,qppr)
Yr = [0, 0, 0, 0, qpp1r, qpp1r/2 + (qpp1r*cos(2*q2))/2 - (qp1*qp2r*sin(2*q2))/2 - (qp2*qp1r*sin(2*q2))/2, - qpp1r*sin(2*q2) - qp1*qp2r*cos(2*q2) - qp2*qp1r*cos(2*q2), qpp2r*cos(q2) - qp2*qp2r*sin(q2), qpp1r/2 - (qpp1r*cos(2*q2))/2 + (qp1*qp2r*sin(2*q2))/2 + (qp2*qp1r*sin(2*q2))/2, - qpp2r*sin(q2) - qp2*qp2r*cos(q2),     0, qpp1r/2 + (qpp1r*cos(2*al + 2*q2 + 2*q3))/2 - (qp1*qp2r*sin(2*al + 2*q2 + 2*q3))/2 - (qp2*qp1r*sin(2*al + 2*q2 + 2*q3))/2 - (qp1*qp3r*sin(2*al + 2*q2 + 2*q3))/2 - (qp3*qp1r*sin(2*al + 2*q2 + 2*q3))/2, - qpp1r*sin(2*al + 2*q2 + 2*q3) - qp1*qp2r*cos(2*al + 2*q2 + 2*q3) - qp2*qp1r*cos(2*al + 2*q2 + 2*q3) - qp1*qp3r*cos(2*al + 2*q2 + 2*q3) - qp3*qp1r*cos(2*al + 2*q2 + 2*q3), qpp2r*cos(al + q2 + q3) + qpp3r*cos(al + q2 + q3) - qp2*qp2r*sin(al + q2 + q3) - qp2*qp3r*sin(al + q2 + q3) - qp3*qp2r*sin(al + q2 + q3) - qp3*qp3r*sin(al + q2 + q3), qpp1r/2 - (qpp1r*cos(2*al + 2*q2 + 2*q3))/2 + (qp1*qp2r*sin(2*al + 2*q2 + 2*q3))/2 + (qp2*qp1r*sin(2*al + 2*q2 + 2*q3))/2 + (qp1*qp3r*sin(2*al + 2*q2 + 2*q3))/2 + (qp3*qp1r*sin(2*al + 2*q2 + 2*q3))/2, - qpp2r*sin(al + q2 + q3) - qpp3r*sin(al + q2 + q3) - qp2*qp2r*cos(al + q2 + q3) - qp2*qp3r*cos(al + q2 + q3) - qp3*qp2r*cos(al + q2 + q3) - qp3*qp3r*cos(al + q2 + q3),             0, qpp1r/2 - (qpp1r*cos(2*q2 + 2*q3 + 2*q4))/2 + (qp1*qp2r*sin(2*q2 + 2*q3 + 2*q4))/2 + (qp2*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2 + (qp1*qp3r*sin(2*q2 + 2*q3 + 2*q4))/2 + (qp3*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2 + (qp1*qp4r*sin(2*q2 + 2*q3 + 2*q4))/2 + (qp4*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2, qpp1r*sin(2*q2 + 2*q3 + 2*q4) + qp1*qp2r*cos(2*q2 + 2*q3 + 2*q4) + qp2*qp1r*cos(2*q2 + 2*q3 + 2*q4) + qp1*qp3r*cos(2*q2 + 2*q3 + 2*q4) + qp3*qp1r*cos(2*q2 + 2*q3 + 2*q4) + qp1*qp4r*cos(2*q2 + 2*q3 + 2*q4) + qp4*qp1r*cos(2*q2 + 2*q3 + 2*q4), - qpp2r*sin(q2 + q3 + q4) - qpp3r*sin(q2 + q3 + q4) - qpp4r*sin(q2 + q3 + q4) - qp2*qp2r*cos(q2 + q3 + q4) - qp2*qp3r*cos(q2 + q3 + q4) - qp3*qp2r*cos(q2 + q3 + q4) - qp2*qp4r*cos(q2 + q3 + q4) - qp3*qp3r*cos(q2 + q3 + q4) - qp4*qp2r*cos(q2 + q3 + q4) - qp3*qp4r*cos(q2 + q3 + q4) - qp4*qp3r*cos(q2 + q3 + q4) - qp4*qp4r*cos(q2 + q3 + q4), qpp1r/2 + (qpp1r*cos(2*q2 + 2*q3 + 2*q4))/2 - (qp1*qp2r*sin(2*q2 + 2*q3 + 2*q4))/2 - (qp2*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2 - (qp1*qp3r*sin(2*q2 + 2*q3 + 2*q4))/2 - (qp3*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2 - (qp1*qp4r*sin(2*q2 + 2*q3 + 2*q4))/2 - (qp4*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2, qp2*qp2r*sin(q2 + q3 + q4) - qpp3r*cos(q2 + q3 + q4) - qpp4r*cos(q2 + q3 + q4) - qpp2r*cos(q2 + q3 + q4) + qp2*qp3r*sin(q2 + q3 + q4) + qp3*qp2r*sin(q2 + q3 + q4) + qp2*qp4r*sin(q2 + q3 + q4) + qp3*qp3r*sin(q2 + q3 + q4) + qp4*qp2r*sin(q2 + q3 + q4) + qp3*qp4r*sin(q2 + q3 + q4) + qp4*qp3r*sin(q2 + q3 + q4) + qp4*qp4r*sin(q2 + q3 + q4),                     0,           0,           0,                     0,           0,                     0,                     0, qpp1r/2 - (qpp1r*cos(2*q2))/2 + (qp1*qp2r*sin(2*q2))/2 + (qp2*qp1r*sin(2*q2))/2, qpp1r/2 - (qpp1r*cos(2*q2))/2 + (qp1*qp2r*sin(2*q2))/2 + (qp2*qp1r*sin(2*q2))/2, qpp1r/2 - (qpp1r*cos(2*al + 2*q2 + 2*q3))/2 + (qp1*qp2r*sin(2*al + 2*q2 + 2*q3))/2 + (qp2*qp1r*sin(2*al + 2*q2 + 2*q3))/2 + (qp1*qp3r*sin(2*al + 2*q2 + 2*q3))/2 + (qp3*qp1r*sin(2*al + 2*q2 + 2*q3))/2, qpp1r/2 - (qpp1r*cos(2*q2))/2 + (qp1*qp2r*sin(2*q2))/2 + (qp2*qp1r*sin(2*q2))/2, qpp1r/2 + (qpp1r*cos(2*q2 + 2*q3 + 2*q4))/2 - (qp1*qp2r*sin(2*q2 + 2*q3 + 2*q4))/2 - (qp2*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2 - (qp1*qp3r*sin(2*q2 + 2*q3 + 2*q4))/2 - (qp3*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2 - (qp1*qp4r*sin(2*q2 + 2*q3 + 2*q4))/2 - (qp4*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2, qpp1r/2 - (qpp1r*cos(2*al + 2*q2 + 2*q3))/2 + (qp1*qp2r*sin(2*al + 2*q2 + 2*q3))/2 + (qp2*qp1r*sin(2*al + 2*q2 + 2*q3))/2 + (qp1*qp3r*sin(2*al + 2*q2 + 2*q3))/2 + (qp3*qp1r*sin(2*al + 2*q2 + 2*q3))/2, qpp1r*cos(al + q3) - qpp1r*cos(al + 2*q2 + q3) + qp1*qp2r*sin(al + 2*q2 + q3) + qp2*qp1r*sin(al + 2*q2 + q3) + (qp1*qp3r*sin(al + 2*q2 + q3))/2 + (qp3*qp1r*sin(al + 2*q2 + q3))/2 - (qp1*qp3r*sin(al + q3))/2 - (qp3*qp1r*sin(al + q3))/2, qpp1r*sin(2*q2 + q3 + q4) - qpp1r*sin(q3 + q4) + qp1*qp2r*cos(2*q2 + q3 + q4) + qp2*qp1r*cos(2*q2 + q3 + q4) + (qp1*qp3r*cos(2*q2 + q3 + q4))/2 + (qp3*qp1r*cos(2*q2 + q3 + q4))/2 + (qp1*qp4r*cos(2*q2 + q3 + q4))/2 + (qp4*qp1r*cos(2*q2 + q3 + q4))/2 - (qp1*qp3r*cos(q3 + q4))/2 - (qp3*qp1r*cos(q3 + q4))/2 - (qp1*qp4r*cos(q3 + q4))/2 - (qp4*qp1r*cos(q3 + q4))/2, qpp1r*sin(al + 2*q2 + 2*q3 + q4) + qpp1r*sin(al - q4) - (qp1*qp4r*cos(al - q4))/2 - (qp4*qp1r*cos(al - q4))/2 + qp1*qp2r*cos(al + 2*q2 + 2*q3 + q4) + qp2*qp1r*cos(al + 2*q2 + 2*q3 + q4) + qp1*qp3r*cos(al + 2*q2 + 2*q3 + q4) + qp3*qp1r*cos(al + 2*q2 + 2*q3 + q4) + (qp1*qp4r*cos(al + 2*q2 + 2*q3 + q4))/2 + (qp4*qp1r*cos(al + 2*q2 + 2*q3 + q4))/2, qpp1r*cos(al + q3) - qpp1r*cos(al + 2*q2 + q3) + qp1*qp2r*sin(al + 2*q2 + q3) + qp2*qp1r*sin(al + 2*q2 + q3) + (qp1*qp3r*sin(al + 2*q2 + q3))/2 + (qp3*qp1r*sin(al + 2*q2 + q3))/2 - (qp1*qp3r*sin(al + q3))/2 - (qp3*qp1r*sin(al + q3))/2;
0, 0, 0, 0,     0,                                                          (qp1*qp1r*sin(2*q2))/2,                                          qp1*qp1r*cos(2*q2),                    qpp1r*cos(q2),                                                         -(qp1*qp1r*sin(2*q2))/2,                     -qpp1r*sin(q2), qpp2r,                                                                                                                                                                    (qp1*qp1r*sin(2*al + 2*q2 + 2*q3))/2,                                                                                                                                            qp1*qp1r*cos(2*al + 2*q2 + 2*q3),                                                                                                                                               qpp1r*cos(al + q2 + q3),                                                                                                                                                                   -(qp1*qp1r*sin(2*al + 2*q2 + 2*q3))/2,                                                                                                                                                -qpp1r*sin(al + q2 + q3), qpp2r + qpp3r,                                                                                                                                                                                                                                                 -(qp1*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2,                                                                                                                                                                                                               -qp1*qp1r*cos(2*q2 + 2*q3 + 2*q4),                                                                                                                                                                                                                                                                                                                           -qpp1r*sin(q2 + q3 + q4),                                                                                                                                                                                                                                                  (qp1*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2,                                                                                                                                                                                                                                                                                                                         -qpp1r*cos(q2 + q3 + q4), qpp2r + qpp3r + qpp4r, -gz*sin(q2), -gz*sin(q2), -gz*sin(al + q2 + q3), -gz*sin(q2), -gz*cos(q2 + q3 + q4), -gz*sin(al + q2 + q3),                                                  qpp2r - (qp1*qp1r*sin(2*q2))/2,                                                  qpp2r - (qp1*qp1r*sin(2*q2))/2,                                                                                                                                                    qpp2r + qpp3r - (qp1*qp1r*sin(2*al + 2*q2 + 2*q3))/2,                                                  qpp2r - (qp1*qp1r*sin(2*q2))/2,                                                                                                                                                                                                                          qpp2r + qpp3r + qpp4r + (qp1*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2,                                                                                                                                                    qpp2r + qpp3r - (qp1*qp1r*sin(2*al + 2*q2 + 2*q3))/2,                                                                                           2*qpp2r*cos(al + q3) + qpp3r*cos(al + q3) - qp1*qp1r*sin(al + 2*q2 + q3) - qp2*qp3r*sin(al + q3) - qp3*qp2r*sin(al + q3) - qp3*qp3r*sin(al + q3),                                                                          - 2*qpp2r*sin(q3 + q4) - qpp3r*sin(q3 + q4) - qpp4r*sin(q3 + q4) - qp1*qp1r*cos(2*q2 + q3 + q4) - qp2*qp3r*cos(q3 + q4) - qp3*qp2r*cos(q3 + q4) - qp2*qp4r*cos(q3 + q4) - qp3*qp3r*cos(q3 + q4) - qp4*qp2r*cos(q3 + q4) - qp3*qp4r*cos(q3 + q4) - qp4*qp3r*cos(q3 + q4) - qp4*qp4r*cos(q3 + q4),                                                                                                                            2*qpp2r*sin(al - q4) + 2*qpp3r*sin(al - q4) + qpp4r*sin(al - q4) - qp2*qp4r*cos(al - q4) - qp4*qp2r*cos(al - q4) - qp3*qp4r*cos(al - q4) - qp4*qp3r*cos(al - q4) - qp4*qp4r*cos(al - q4) - qp1*qp1r*cos(al + 2*q2 + 2*q3 + q4),                                                                                           2*qpp2r*cos(al + q3) + qpp3r*cos(al + q3) - qp1*qp1r*sin(al + 2*q2 + q3) - qp2*qp3r*sin(al + q3) - qp3*qp2r*sin(al + q3) - qp3*qp3r*sin(al + q3);
0, 0, 0, 0,     0,                                                                               0,                                                           0,                                0,                                                                               0,                                  0,     0,                                                                                                                                                                    (qp1*qp1r*sin(2*al + 2*q2 + 2*q3))/2,                                                                                                                                            qp1*qp1r*cos(2*al + 2*q2 + 2*q3),                                                                                                                                               qpp1r*cos(al + q2 + q3),                                                                                                                                                                   -(qp1*qp1r*sin(2*al + 2*q2 + 2*q3))/2,                                                                                                                                                -qpp1r*sin(al + q2 + q3), qpp2r + qpp3r,                                                                                                                                                                                                                                                 -(qp1*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2,                                                                                                                                                                                                               -qp1*qp1r*cos(2*q2 + 2*q3 + 2*q4),                                                                                                                                                                                                                                                                                                                           -qpp1r*sin(q2 + q3 + q4),                                                                                                                                                                                                                                                  (qp1*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2,                                                                                                                                                                                                                                                                                                                         -qpp1r*cos(q2 + q3 + q4), qpp2r + qpp3r + qpp4r,           0,           0, -gz*sin(al + q2 + q3),           0, -gz*cos(q2 + q3 + q4), -gz*sin(al + q2 + q3),                                                                               0,                                                                               0,                                                                                                                                                    qpp2r + qpp3r - (qp1*qp1r*sin(2*al + 2*q2 + 2*q3))/2,                                                                               0,                                                                                                                                                                                                                          qpp2r + qpp3r + qpp4r + (qp1*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2,                                                                                                                                                    qpp2r + qpp3r - (qp1*qp1r*sin(2*al + 2*q2 + 2*q3))/2,                                                                                                                                  qpp2r*cos(al + q3) - (qp1*qp1r*sin(al + 2*q2 + q3))/2 + (qp1*qp1r*sin(al + q3))/2 + qp2*qp2r*sin(al + q3),                                                                                                                                                                                                                                                                (qp1*qp1r*cos(q3 + q4))/2 - (qp1*qp1r*cos(2*q2 + q3 + q4))/2 - qpp2r*sin(q3 + q4) + qp2*qp2r*cos(q3 + q4),                                                                                                                            2*qpp2r*sin(al - q4) + 2*qpp3r*sin(al - q4) + qpp4r*sin(al - q4) - qp2*qp4r*cos(al - q4) - qp4*qp2r*cos(al - q4) - qp3*qp4r*cos(al - q4) - qp4*qp3r*cos(al - q4) - qp4*qp4r*cos(al - q4) - qp1*qp1r*cos(al + 2*q2 + 2*q3 + q4),                                                                                                                                  qpp2r*cos(al + q3) - (qp1*qp1r*sin(al + 2*q2 + q3))/2 + (qp1*qp1r*sin(al + q3))/2 + qp2*qp2r*sin(al + q3);
0, 0, 0, 0,     0,                                                                               0,                                                           0,                                0,                                                                               0,                                  0,     0,                                                                                                                                                                                                       0,                                                                                                                                                                           0,                                                                                                                                                                     0,                                                                                                                                                                                                       0,                                                                                                                                                                       0,             0,                                                                                                                                                                                                                                                 -(qp1*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2,                                                                                                                                                                                                               -qp1*qp1r*cos(2*q2 + 2*q3 + 2*q4),                                                                                                                                                                                                                                                                                                                           -qpp1r*sin(q2 + q3 + q4),                                                                                                                                                                                                                                                  (qp1*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2,                                                                                                                                                                                                                                                                                                                         -qpp1r*cos(q2 + q3 + q4), qpp2r + qpp3r + qpp4r,           0,           0,                     0,           0, -gz*cos(q2 + q3 + q4),                     0,                                                                               0,                                                                               0,                                                                                                                                                                                                       0,                                                                               0,                                                                                                                                                                                                                          qpp2r + qpp3r + qpp4r + (qp1*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2,                                                                                                                                                                                                       0,                                                                                                                                                                                                                                          0,                                                                                                                                                                                                                                                                (qp1*qp1r*cos(q3 + q4))/2 - (qp1*qp1r*cos(2*q2 + q3 + q4))/2 - qpp2r*sin(q3 + q4) + qp2*qp2r*cos(q3 + q4),                                                                                                                                             qpp2r*sin(al - q4) + qpp3r*sin(al - q4) + (qp1*qp1r*cos(al - q4))/2 + qp2*qp2r*cos(al - q4) + qp2*qp3r*cos(al - q4) + qp3*qp2r*cos(al - q4) + qp3*qp3r*cos(al - q4) - (qp1*qp1r*cos(al + 2*q2 + 2*q3 + q4))/2,                                                                                                                                                                                                                                          0]; 

% TODO: Define the robot regressor extensio with the viscous friction
% coefficients
Yr_Beta=diag([qp1r, qp2r, qp3r, qp4r])

% TODO: Extended regressor with robot dynamic model and viscous friction
Yr_ex=[qp1r,    0,    0,    0, qpp1r, qpp1r/2 + (qpp1r*cos(2*q2))/2 - (qp1*qp2r*sin(2*q2))/2 - (qp2*qp1r*sin(2*q2))/2, - qpp1r*sin(2*q2) - qp1*qp2r*cos(2*q2) - qp2*qp1r*cos(2*q2), qpp2r*cos(q2) - qp2*qp2r*sin(q2), qpp1r/2 - (qpp1r*cos(2*q2))/2 + (qp1*qp2r*sin(2*q2))/2 + (qp2*qp1r*sin(2*q2))/2, - qpp2r*sin(q2) - qp2*qp2r*cos(q2),     0, qpp1r/2 + (qpp1r*cos(2*al + 2*q2 + 2*q3))/2 - (qp1*qp2r*sin(2*al + 2*q2 + 2*q3))/2 - (qp2*qp1r*sin(2*al + 2*q2 + 2*q3))/2 - (qp1*qp3r*sin(2*al + 2*q2 + 2*q3))/2 - (qp3*qp1r*sin(2*al + 2*q2 + 2*q3))/2, - qpp1r*sin(2*al + 2*q2 + 2*q3) - qp1*qp2r*cos(2*al + 2*q2 + 2*q3) - qp2*qp1r*cos(2*al + 2*q2 + 2*q3) - qp1*qp3r*cos(2*al + 2*q2 + 2*q3) - qp3*qp1r*cos(2*al + 2*q2 + 2*q3), qpp2r*cos(al + q2 + q3) + qpp3r*cos(al + q2 + q3) - qp2*qp2r*sin(al + q2 + q3) - qp2*qp3r*sin(al + q2 + q3) - qp3*qp2r*sin(al + q2 + q3) - qp3*qp3r*sin(al + q2 + q3), qpp1r/2 - (qpp1r*cos(2*al + 2*q2 + 2*q3))/2 + (qp1*qp2r*sin(2*al + 2*q2 + 2*q3))/2 + (qp2*qp1r*sin(2*al + 2*q2 + 2*q3))/2 + (qp1*qp3r*sin(2*al + 2*q2 + 2*q3))/2 + (qp3*qp1r*sin(2*al + 2*q2 + 2*q3))/2, - qpp2r*sin(al + q2 + q3) - qpp3r*sin(al + q2 + q3) - qp2*qp2r*cos(al + q2 + q3) - qp2*qp3r*cos(al + q2 + q3) - qp3*qp2r*cos(al + q2 + q3) - qp3*qp3r*cos(al + q2 + q3),             0, qpp1r/2 - (qpp1r*cos(2*q2 + 2*q3 + 2*q4))/2 + (qp1*qp2r*sin(2*q2 + 2*q3 + 2*q4))/2 + (qp2*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2 + (qp1*qp3r*sin(2*q2 + 2*q3 + 2*q4))/2 + (qp3*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2 + (qp1*qp4r*sin(2*q2 + 2*q3 + 2*q4))/2 + (qp4*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2, qpp1r*sin(2*q2 + 2*q3 + 2*q4) + qp1*qp2r*cos(2*q2 + 2*q3 + 2*q4) + qp2*qp1r*cos(2*q2 + 2*q3 + 2*q4) + qp1*qp3r*cos(2*q2 + 2*q3 + 2*q4) + qp3*qp1r*cos(2*q2 + 2*q3 + 2*q4) + qp1*qp4r*cos(2*q2 + 2*q3 + 2*q4) + qp4*qp1r*cos(2*q2 + 2*q3 + 2*q4), - qpp2r*sin(q2 + q3 + q4) - qpp3r*sin(q2 + q3 + q4) - qpp4r*sin(q2 + q3 + q4) - qp2*qp2r*cos(q2 + q3 + q4) - qp2*qp3r*cos(q2 + q3 + q4) - qp3*qp2r*cos(q2 + q3 + q4) - qp2*qp4r*cos(q2 + q3 + q4) - qp3*qp3r*cos(q2 + q3 + q4) - qp4*qp2r*cos(q2 + q3 + q4) - qp3*qp4r*cos(q2 + q3 + q4) - qp4*qp3r*cos(q2 + q3 + q4) - qp4*qp4r*cos(q2 + q3 + q4), qpp1r/2 + (qpp1r*cos(2*q2 + 2*q3 + 2*q4))/2 - (qp1*qp2r*sin(2*q2 + 2*q3 + 2*q4))/2 - (qp2*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2 - (qp1*qp3r*sin(2*q2 + 2*q3 + 2*q4))/2 - (qp3*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2 - (qp1*qp4r*sin(2*q2 + 2*q3 + 2*q4))/2 - (qp4*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2, qp2*qp2r*sin(q2 + q3 + q4) - qpp3r*cos(q2 + q3 + q4) - qpp4r*cos(q2 + q3 + q4) - qpp2r*cos(q2 + q3 + q4) + qp2*qp3r*sin(q2 + q3 + q4) + qp3*qp2r*sin(q2 + q3 + q4) + qp2*qp4r*sin(q2 + q3 + q4) + qp3*qp3r*sin(q2 + q3 + q4) + qp4*qp2r*sin(q2 + q3 + q4) + qp3*qp4r*sin(q2 + q3 + q4) + qp4*qp3r*sin(q2 + q3 + q4) + qp4*qp4r*sin(q2 + q3 + q4),                     0,           0,           0,                     0,           0,                     0,                     0, qpp1r/2 - (qpp1r*cos(2*q2))/2 + (qp1*qp2r*sin(2*q2))/2 + (qp2*qp1r*sin(2*q2))/2, qpp1r/2 - (qpp1r*cos(2*q2))/2 + (qp1*qp2r*sin(2*q2))/2 + (qp2*qp1r*sin(2*q2))/2, qpp1r/2 - (qpp1r*cos(2*al + 2*q2 + 2*q3))/2 + (qp1*qp2r*sin(2*al + 2*q2 + 2*q3))/2 + (qp2*qp1r*sin(2*al + 2*q2 + 2*q3))/2 + (qp1*qp3r*sin(2*al + 2*q2 + 2*q3))/2 + (qp3*qp1r*sin(2*al + 2*q2 + 2*q3))/2, qpp1r/2 - (qpp1r*cos(2*q2))/2 + (qp1*qp2r*sin(2*q2))/2 + (qp2*qp1r*sin(2*q2))/2, qpp1r/2 + (qpp1r*cos(2*q2 + 2*q3 + 2*q4))/2 - (qp1*qp2r*sin(2*q2 + 2*q3 + 2*q4))/2 - (qp2*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2 - (qp1*qp3r*sin(2*q2 + 2*q3 + 2*q4))/2 - (qp3*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2 - (qp1*qp4r*sin(2*q2 + 2*q3 + 2*q4))/2 - (qp4*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2, qpp1r/2 - (qpp1r*cos(2*al + 2*q2 + 2*q3))/2 + (qp1*qp2r*sin(2*al + 2*q2 + 2*q3))/2 + (qp2*qp1r*sin(2*al + 2*q2 + 2*q3))/2 + (qp1*qp3r*sin(2*al + 2*q2 + 2*q3))/2 + (qp3*qp1r*sin(2*al + 2*q2 + 2*q3))/2, qpp1r*cos(al + q3) - qpp1r*cos(al + 2*q2 + q3) + qp1*qp2r*sin(al + 2*q2 + q3) + qp2*qp1r*sin(al + 2*q2 + q3) + (qp1*qp3r*sin(al + 2*q2 + q3))/2 + (qp3*qp1r*sin(al + 2*q2 + q3))/2 - (qp1*qp3r*sin(al + q3))/2 - (qp3*qp1r*sin(al + q3))/2, qpp1r*sin(2*q2 + q3 + q4) - qpp1r*sin(q3 + q4) + qp1*qp2r*cos(2*q2 + q3 + q4) + qp2*qp1r*cos(2*q2 + q3 + q4) + (qp1*qp3r*cos(2*q2 + q3 + q4))/2 + (qp3*qp1r*cos(2*q2 + q3 + q4))/2 + (qp1*qp4r*cos(2*q2 + q3 + q4))/2 + (qp4*qp1r*cos(2*q2 + q3 + q4))/2 - (qp1*qp3r*cos(q3 + q4))/2 - (qp3*qp1r*cos(q3 + q4))/2 - (qp1*qp4r*cos(q3 + q4))/2 - (qp4*qp1r*cos(q3 + q4))/2, qpp1r*sin(al + 2*q2 + 2*q3 + q4) + qpp1r*sin(al - q4) - (qp1*qp4r*cos(al - q4))/2 - (qp4*qp1r*cos(al - q4))/2 + qp1*qp2r*cos(al + 2*q2 + 2*q3 + q4) + qp2*qp1r*cos(al + 2*q2 + 2*q3 + q4) + qp1*qp3r*cos(al + 2*q2 + 2*q3 + q4) + qp3*qp1r*cos(al + 2*q2 + 2*q3 + q4) + (qp1*qp4r*cos(al + 2*q2 + 2*q3 + q4))/2 + (qp4*qp1r*cos(al + 2*q2 + 2*q3 + q4))/2, qpp1r*cos(al + q3) - qpp1r*cos(al + 2*q2 + q3) + qp1*qp2r*sin(al + 2*q2 + q3) + qp2*qp1r*sin(al + 2*q2 + q3) + (qp1*qp3r*sin(al + 2*q2 + q3))/2 + (qp3*qp1r*sin(al + 2*q2 + q3))/2 - (qp1*qp3r*sin(al + q3))/2 - (qp3*qp1r*sin(al + q3))/2;
   0, qp2r,    0,    0,     0,                                                          (qp1*qp1r*sin(2*q2))/2,                                          qp1*qp1r*cos(2*q2),                    qpp1r*cos(q2),                                                         -(qp1*qp1r*sin(2*q2))/2,                     -qpp1r*sin(q2), qpp2r,                                                                                                                                                                    (qp1*qp1r*sin(2*al + 2*q2 + 2*q3))/2,                                                                                                                                            qp1*qp1r*cos(2*al + 2*q2 + 2*q3),                                                                                                                                               qpp1r*cos(al + q2 + q3),                                                                                                                                                                   -(qp1*qp1r*sin(2*al + 2*q2 + 2*q3))/2,                                                                                                                                                -qpp1r*sin(al + q2 + q3), qpp2r + qpp3r,                                                                                                                                                                                                                                                 -(qp1*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2,                                                                                                                                                                                                               -qp1*qp1r*cos(2*q2 + 2*q3 + 2*q4),                                                                                                                                                                                                                                                                                                                           -qpp1r*sin(q2 + q3 + q4),                                                                                                                                                                                                                                                  (qp1*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2,                                                                                                                                                                                                                                                                                                                         -qpp1r*cos(q2 + q3 + q4), qpp2r + qpp3r + qpp4r, -gz*sin(q2), -gz*sin(q2), -gz*sin(al + q2 + q3), -gz*sin(q2), -gz*cos(q2 + q3 + q4), -gz*sin(al + q2 + q3),                                                  qpp2r - (qp1*qp1r*sin(2*q2))/2,                                                  qpp2r - (qp1*qp1r*sin(2*q2))/2,                                                                                                                                                    qpp2r + qpp3r - (qp1*qp1r*sin(2*al + 2*q2 + 2*q3))/2,                                                  qpp2r - (qp1*qp1r*sin(2*q2))/2,                                                                                                                                                                                                                          qpp2r + qpp3r + qpp4r + (qp1*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2,                                                                                                                                                    qpp2r + qpp3r - (qp1*qp1r*sin(2*al + 2*q2 + 2*q3))/2,                                                                                           2*qpp2r*cos(al + q3) + qpp3r*cos(al + q3) - qp1*qp1r*sin(al + 2*q2 + q3) - qp2*qp3r*sin(al + q3) - qp3*qp2r*sin(al + q3) - qp3*qp3r*sin(al + q3),                                                                          - 2*qpp2r*sin(q3 + q4) - qpp3r*sin(q3 + q4) - qpp4r*sin(q3 + q4) - qp1*qp1r*cos(2*q2 + q3 + q4) - qp2*qp3r*cos(q3 + q4) - qp3*qp2r*cos(q3 + q4) - qp2*qp4r*cos(q3 + q4) - qp3*qp3r*cos(q3 + q4) - qp4*qp2r*cos(q3 + q4) - qp3*qp4r*cos(q3 + q4) - qp4*qp3r*cos(q3 + q4) - qp4*qp4r*cos(q3 + q4),                                                                                                                            2*qpp2r*sin(al - q4) + 2*qpp3r*sin(al - q4) + qpp4r*sin(al - q4) - qp2*qp4r*cos(al - q4) - qp4*qp2r*cos(al - q4) - qp3*qp4r*cos(al - q4) - qp4*qp3r*cos(al - q4) - qp4*qp4r*cos(al - q4) - qp1*qp1r*cos(al + 2*q2 + 2*q3 + q4),                                                                                           2*qpp2r*cos(al + q3) + qpp3r*cos(al + q3) - qp1*qp1r*sin(al + 2*q2 + q3) - qp2*qp3r*sin(al + q3) - qp3*qp2r*sin(al + q3) - qp3*qp3r*sin(al + q3);
   0,    0, qp3r,    0,     0,                                                                               0,                                                           0,                                0,                                                                               0,                                  0,     0,                                                                                                                                                                    (qp1*qp1r*sin(2*al + 2*q2 + 2*q3))/2,                                                                                                                                            qp1*qp1r*cos(2*al + 2*q2 + 2*q3),                                                                                                                                               qpp1r*cos(al + q2 + q3),                                                                                                                                                                   -(qp1*qp1r*sin(2*al + 2*q2 + 2*q3))/2,                                                                                                                                                -qpp1r*sin(al + q2 + q3), qpp2r + qpp3r,                                                                                                                                                                                                                                                 -(qp1*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2,                                                                                                                                                                                                               -qp1*qp1r*cos(2*q2 + 2*q3 + 2*q4),                                                                                                                                                                                                                                                                                                                           -qpp1r*sin(q2 + q3 + q4),                                                                                                                                                                                                                                                  (qp1*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2,                                                                                                                                                                                                                                                                                                                         -qpp1r*cos(q2 + q3 + q4), qpp2r + qpp3r + qpp4r,           0,           0, -gz*sin(al + q2 + q3),           0, -gz*cos(q2 + q3 + q4), -gz*sin(al + q2 + q3),                                                                               0,                                                                               0,                                                                                                                                                    qpp2r + qpp3r - (qp1*qp1r*sin(2*al + 2*q2 + 2*q3))/2,                                                                               0,                                                                                                                                                                                                                          qpp2r + qpp3r + qpp4r + (qp1*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2,                                                                                                                                                    qpp2r + qpp3r - (qp1*qp1r*sin(2*al + 2*q2 + 2*q3))/2,                                                                                                                                  qpp2r*cos(al + q3) - (qp1*qp1r*sin(al + 2*q2 + q3))/2 + (qp1*qp1r*sin(al + q3))/2 + qp2*qp2r*sin(al + q3),                                                                                                                                                                                                                                                                (qp1*qp1r*cos(q3 + q4))/2 - (qp1*qp1r*cos(2*q2 + q3 + q4))/2 - qpp2r*sin(q3 + q4) + qp2*qp2r*cos(q3 + q4),                                                                                                                            2*qpp2r*sin(al - q4) + 2*qpp3r*sin(al - q4) + qpp4r*sin(al - q4) - qp2*qp4r*cos(al - q4) - qp4*qp2r*cos(al - q4) - qp3*qp4r*cos(al - q4) - qp4*qp3r*cos(al - q4) - qp4*qp4r*cos(al - q4) - qp1*qp1r*cos(al + 2*q2 + 2*q3 + q4),                                                                                                                                  qpp2r*cos(al + q3) - (qp1*qp1r*sin(al + 2*q2 + q3))/2 + (qp1*qp1r*sin(al + q3))/2 + qp2*qp2r*sin(al + q3);
   0,    0,    0, qp4r,     0,                                                                               0,                                                           0,                                0,                                                                               0,                                  0,     0,                                                                                                                                                                                                       0,                                                                                                                                                                           0,                                                                                                                                                                     0,                                                                                                                                                                                                       0,                                                                                                                                                                       0,             0,                                                                                                                                                                                                                                                 -(qp1*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2,                                                                                                                                                                                                               -qp1*qp1r*cos(2*q2 + 2*q3 + 2*q4),                                                                                                                                                                                                                                                                                                                           -qpp1r*sin(q2 + q3 + q4),                                                                                                                                                                                                                                                  (qp1*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2,                                                                                                                                                                                                                                                                                                                         -qpp1r*cos(q2 + q3 + q4), qpp2r + qpp3r + qpp4r,           0,           0,                     0,           0, -gz*cos(q2 + q3 + q4),                     0,                                                                               0,                                                                               0,                                                                                                                                                                                                       0,                                                                               0,                                                                                                                                                                                                                          qpp2r + qpp3r + qpp4r + (qp1*qp1r*sin(2*q2 + 2*q3 + 2*q4))/2,                                                                                                                                                                                                       0,                                                                                                                                                                                                                                          0,                                                                                                                                                                                                                                                                (qp1*qp1r*cos(q3 + q4))/2 - (qp1*qp1r*cos(2*q2 + q3 + q4))/2 - qpp2r*sin(q3 + q4) + qp2*qp2r*cos(q3 + q4),                                                                                                                                             qpp2r*sin(al - q4) + qpp3r*sin(al - q4) + (qp1*qp1r*cos(al - q4))/2 + qp2*qp2r*cos(al - q4) + qp2*qp3r*cos(al - q4) + qp3*qp2r*cos(al - q4) + qp3*qp3r*cos(al - q4) - (qp1*qp1r*cos(al + 2*q2 + 2*q3 + q4))/2,                                                                                                                                                                                                                                          0];
   

% Regressor serialization
% TODO: define the variables n=DOFs, p=number of parameters
n=size(Yr_ex,1);
p=size(Yr_ex,2);
Yr_out=reshape(Yr_ex,n*p,1);

%To recover the Yr matrix
%Yr_in=reshape(Yr_out,n,p);

end

